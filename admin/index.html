<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel | Mwaniki Reports</title>
  <link href="/globals.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cheerio@1.0.0/dist/browser/cheerio.min.js"></script>
</head>
<body class="bg-background text-foreground">
  <div class="container mx-auto px-4 py-8">
    <div id="auth-section" class="hidden text-center">
      <h1 class="text-2xl font-bold text-slate-900 mb-6">Admin Panel</h1>
      <p class="text-slate-600 mb-4">Please sign in to access the admin panel.</p>
      <form id="signin-form" class="space-y-4 max-w-md mx-auto">
        <input
          type="text"
          id="username"
          placeholder="Username"
          class="w-full p-2 border border-slate-200 rounded"
        />
        <input
          type="password"
          id="password"
          placeholder="Password"
          class="w-full p-2 border border-slate-200 rounded"
        />
        <p id="error" class="text-red-600 hidden"></p>
        <button
          type="submit"
          class="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
        >
          Sign In
        </button>
      </form>
    </div>

    <div id="admin-section" class="hidden">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-slate-900">Admin Panel</h1>
        <button
          id="signout-btn"
          class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
        >
          Sign Out
        </button>
      </div>
      <section class="mb-12">
        <h2 class="text-xl font-semibold mb-4">Posts</h2>
        <ul id="post-list" class="space-y-4"></ul>
      </section>
      <section id="edit-section" class="hidden bg-white p-6 rounded-lg shadow">
        <h2 class="text-xl font-semibold mb-4">Edit Post</h2>
        <div class="space-y-4">
          <input
            type="text"
            id="edit-title"
            class="w-full p-2 border border-slate-200 rounded"
            placeholder="Title"
          />
          <textarea
            id="edit-description"
            class="w-full p-2 border border-slate-200 rounded"
            placeholder="Description"
          ></textarea>
          <input
            type="text"
            id="edit-image"
            class="w-full p-2 border border-slate-200 rounded"
            placeholder="Image URL"
          />
          <select id="edit-category" class="w-full p-2 border border-slate-200 rounded">
            <option value="Breaking News">Breaking News</option>
            <option value="News">News</option>
            <option value="Sports">Sports</option>
            <option value="Entertainment">Entertainment</option>
            <option value="Tech">Tech</option>
            <option value="Opinions">Opinions</option>
          </select>
          <input
            type="date"
            id="edit-date"
            class="w-full p-2 border border-slate-200 rounded"
          />
          <label class="flex items-center gap-2">
            <input type="checkbox" id="edit-featured" />
            Featured
          </label>
          <input
            type="number"
            id="edit-views"
            class="w-full p-2 border border-slate-200 rounded"
            placeholder="Views"
          />
          <div class="border border-slate-200 rounded">
            <div id="editor" class="min-h-[200px]"></div>
          </div>
          <div class="flex gap-2">
            <button
              id="save-btn"
              class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"
            >
              Save
            </button>
            <button
              id="cancel-btn"
              class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700"
            >
              Cancel
            </button>
          </div>
        </div>
      </section>
    </div>
  </div>
  <script>
    let quill = null;
    let articles = [];

    // Check auth status
    fetch('/api/auth/session')
      .then(res => res.json())
      .then(data => {
        if (data.user) {
          document.getElementById('admin-section').classList.remove('hidden');
          loadPosts();
        } else {
          document.getElementById('auth-section').classList.remove('hidden');
        }
      });

    // Sign-in form
    document.getElementById('signin-form').addEventListener('submit', async e => {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const res = await fetch('/api/auth/signin', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password }),
      });
      if (res.ok) {
        window.location.reload();
      } else {
        document.getElementById('error').textContent = 'Invalid credentials';
        document.getElementById('error').classList.remove('hidden');
      }
    });

    // Sign out
    document.getElementById('signout-btn').addEventListener('click', () => {
      fetch('/api/auth/signout', { method: 'POST' }).then(() => {
        window.location.reload();
      });
    });

    // Load posts
    async function loadPosts() {
      const res = await fetch('/api/articles');
      articles = await res.json();
      const postList = document.getElementById('post-list');
      postList.innerHTML = articles
        .map(
          post => `
            <li class="flex justify-between items-center bg-white p-4 rounded-lg shadow">
              <span class="text-slate-900">${post.title}</span>
              <div class="flex gap-2">
                <button onclick="editPost(${post.id})" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">
                  Edit
                </button>
                <button onclick="deletePost(${post.id})" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700">
                  Delete
                </button>
              </div>
            </li>
          `
        )
        .join('');
    }

    // Edit post
    function editPost(id) {
      const post = articles.find(p => p.id === id);
      document.getElementById('edit-title').value = post.title;
      document.getElementById('edit-description').value = post.description;
      document.getElementById('edit-image').value = post.image;
      document.getElementById('edit-category').value = post.category;
      document.getElementById('edit-date').value = post.date.split('T')[0];
      document.getElementById('edit-featured').checked = post.isFeatured;
      document.getElementById('edit-views').value = post.views;
      document.getElementById('edit-section').classList.remove('hidden');

      if (!quill) {
        quill = new Quill('#editor', {
          theme: 'snow',
          modules: { toolbar: [['bold', 'italic'], ['link'], [{ list: 'ordered' }, { list: 'bullet' }]] },
        });
        quill.on('text-change', () => {
          const html = quill.root.innerHTML;
          const $ = cheerio.load(html);
          const plainText = $.text().replace(/\n\s*\n/g, '\n\n').trim();
          document.getElementById('edit-section').dataset.content = plainText;
        });
      }
      quill.root.innerHTML = post.content.replace(/\n\n/g, '<p><br></p>');
      document.getElementById('edit-section').dataset.id = id;
    }

    // Save post
    document.getElementById('save-btn').addEventListener('click', async () => {
      const id = parseInt(document.getElementById('edit-section').dataset.id);
      const updatedPost = {
        id,
        title: document.getElementById('edit-title').value,
        description: document.getElementById('edit-description').value,
        image: document.getElementById('edit-image').value,
        category: document.getElementById('edit-category').value,
        date: document.getElementById('edit-date').value + 'T00:00:00Z',
        isFeatured: document.getElementById('edit-featured').checked,
        views: parseInt(document.getElementById('edit-views').value) || 0,
        content: document.getElementById('edit-section').dataset.content,
      };
      const updatedArticles = articles.map(post => (post.id === id ? updatedPost : post));
      await fetch('/api/articles', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updatedArticles),
      });
      articles = updatedArticles;
      document.getElementById('edit-section').classList.add('hidden');
      loadPosts();
    });

    // Cancel edit
    document.getElementById('cancel-btn').addEventListener('click', () => {
      document.getElementById('edit-section').classList.add('hidden');
    });

    // Delete post
    async function deletePost(id) {
      if (!confirm('Are you sure you want to delete this post?')) return;
      const updatedArticles = articles.filter(post => post.id !== id);
      await fetch('/api/articles', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updatedArticles),
      });
      articles = updatedArticles;
      loadPosts();
    }
  </script>
</body>
</html>